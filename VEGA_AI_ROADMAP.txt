════════════════════════════════════════════════════════════════════════════════
                      VEGA AI AGENT — ПЛАН РАЗВИТИЯ
════════════════════════════════════════════════════════════════════════════════

Документ: План улучшений AI-агента для CRM
Дата: Декабрь 2025
Версия: 1.0

────────────────────────────────────────────────────────────────────────────────
                         ТЕКУЩЕЕ СОСТОЯНИЕ
────────────────────────────────────────────────────────────────────────────────

AI-агент автоматически генерирует подсказки операторам при входящих 
сообщениях от клиентов. Использует:
  • RAG-поиск по базе знаний
  • Few-shot примеры из успешных ответов
  • Адаптацию под стиль оператора
  • QC-анализ (SLA, жалобы)
  • Обратную связь через Telegram

════════════════════════════════════════════════════════════════════════════════
                    КРИТИЧНЫЕ УЛУЧШЕНИЯ (Приоритет 1)
════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  1. ЗАЩИТА ОТ СПАМА И RATE LIMITING                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Каждое сообщение клиента мгновенно триггерит запрос к AI.       │
│             При спаме — много бессмысленных подсказок и расходы на API.     │
│                                                                             │
│  Решение:   Debounce — собирать сообщения за последние 10-30 секунд         │
│             в один запрос. Экономия токенов и релевантнее контекст.         │
│                                                                             │
│  Оценка:    3-4 часа разработки                                             │
│  Эффект:    Снижение расходов на API до 40%, меньше шума для операторов     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  2. FALLBACK ПРИ ОШИБКАХ API                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Если OpenRouter/OpenAI недоступен — оператор ничего не получит. │
│                                                                             │
│  Решение:   • Retry с exponential backoff (3 попытки)                       │
│             • Fallback на альтернативную модель                             │
│             • Уведомление "Не удалось сгенерировать" если всё упало         │
│                                                                             │
│  Оценка:    2-3 часа разработки                                             │
│  Эффект:    Надёжность системы 99%+                                         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  3. БЕЗОПАСНОСТЬ — SQL INJECTION                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  В Edge Functions используется строковая интерполяция SQL.       │
│             Потенциальная уязвимость при манипуляции с данными.             │
│                                                                             │
│  Решение:   Параметризованные запросы или строгая валидация входных данных. │
│                                                                             │
│  Оценка:    4-5 часов рефакторинга                                          │
│  Эффект:    Устранение критической уязвимости                               │
└─────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
                    УЛУЧШЕНИЯ UX (Приоритет 2)
════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  4. УМНОЕ УПРАВЛЕНИЕ КОНТЕКСТОМ                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Загружается до 100 сообщений истории — может превысить          │
│             контекстное окно модели, потеря качества.                       │
│                                                                             │
│  Решение:   • Подсчёт токенов и умная обрезка                               │
│             • Суммаризация старых сообщений                                 │
│             • Приоритет последним 10-15 сообщениям                          │
│                                                                             │
│  Оценка:    4-6 часов                                                       │
│  Эффект:    Стабильное качество ответов независимо от длины диалога         │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  5. КНОПКА "ОТПРАВИТЬ КЛИЕНТУ"                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Оператор копирует подсказку вручную и вставляет в чат.          │
│             Лишние действия, потеря времени.                                │
│                                                                             │
│  Решение:   Добавить кнопку в Telegram, которая сразу отправляет            │
│             сгенерированный ответ клиенту в чат CRM.                        │
│                                                                             │
│  Оценка:    3-4 часа                                                        │
│  Эффект:    Ускорение работы оператора на 30-50%                            │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  6. КНОПКА "ПЕРЕГЕНЕРИРОВАТЬ"                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Если подсказка не подошла — нет возможности получить другую.    │
│                                                                             │
│  Решение:   Кнопка "🔄 Другой вариант" в Telegram — генерирует новый ответ  │
│             с повышенной temperature для разнообразия.                      │
│                                                                             │
│  Оценка:    2 часа                                                          │
│  Эффект:    Повышение % полезных подсказок                                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  7. ССЫЛКА НА СДЕЛКУ В CRM                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Оператор не видит контекст сделки, нужно искать вручную.        │
│                                                                             │
│  Решение:   Добавить в сообщение кликабельную ссылку на сделку/контакт.     │
│                                                                             │
│  Оценка:    1 час                                                           │
│  Эффект:    Быстрый доступ к полной информации о клиенте                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  8. ТАЙМЕР ОЖИДАНИЯ КЛИЕНТА                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Оператор не видит как долго клиент ждёт ответа.                 │
│                                                                             │
│  Решение:   Показывать "⏱ Клиент ждёт уже 7 мин" в подсказке.               │
│                                                                             │
│  Оценка:    30 минут                                                        │
│  Эффект:    Приоритизация срочных запросов, соблюдение SLA                  │
└─────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
                    УМНЫЕ ФИЧИ (Приоритет 3)
════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  9. ИНТЕНТ-ДЕТЕКЦИЯ И МАРШРУТИЗАЦИЯ                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  AI отвечает одинаково на всё — вопросы, жалобы, благодарности.  │
│                                                                             │
│  Решение:   Предварительная классификация намерения клиента:                │
│             • Вопрос → стандартный ответ                                    │
│             • Жалоба → эмпатичный ответ + эскалация менеджеру               │
│             • Благодарность → короткий ответ без развёрнутой подсказки      │
│             • Срочность → приоритетное уведомление                          │
│                                                                             │
│  Оценка:    6-8 часов                                                       │
│  Эффект:    Более релевантные ответы, автоматическая эскалация проблем      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  10. ИНТЕГРАЦИЯ С ДАННЫМИ CRM                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  AI не знает что это VIP-клиент или сделка на крупную сумму.     │
│                                                                             │
│  Решение:   Подтягивать в промпт:                                           │
│             • Статус контакта (VIP, новый, проблемный)                      │
│             • Сумму сделки                                                  │
│             • Историю покупок                                               │
│             • Предыдущие обращения                                          │
│                                                                             │
│  Оценка:    4-5 часов                                                       │
│  Эффект:    Персонализированные ответы, учёт ценности клиента               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  11. РАНЖИРОВАНИЕ FEW-SHOT ПРИМЕРОВ                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Примеры берутся только по similarity — не учитывается качество. │
│                                                                             │
│  Решение:   Добавить веса:                                                  │
│             • "edited" (отредактированные оператором) > "good"              │
│             • Свежие примеры > старые                                       │
│             • От опытных операторов > от новичков                           │
│                                                                             │
│  Оценка:    3-4 часа                                                        │
│  Эффект:    Качественнее few-shot learning, лучше стиль ответов             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  12. ОТСЛЕЖИВАНИЕ НАСТРОЕНИЯ КЛИЕНТА                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Не видно как меняется настроение клиента по ходу диалога.       │
│                                                                             │
│  Решение:   Sentiment analysis каждого сообщения:                           │
│             • График настроения в карточке сделки                           │
│             • Алерт если sentiment резко падает                             │
│             • Автоматическая эскалация при негативе                         │
│                                                                             │
│  Оценка:    6-8 часов                                                       │
│  Эффект:    Раннее обнаружение проблем, предотвращение потери клиентов      │
└─────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
                    АНАЛИТИКА И ОПТИМИЗАЦИЯ (Приоритет 4)
════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  13. A/B ТЕСТИРОВАНИЕ ПРОМПТОВ                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Непонятно какой system_prompt работает лучше.                   │
│                                                                             │
│  Решение:   • Версионирование промптов                                      │
│             • Случайное распределение по версиям                            │
│             • Метрики (% good feedback) по каждой версии                    │
│             • Автовыбор лучшей версии                                       │
│                                                                             │
│  Оценка:    8-10 часов                                                      │
│  Эффект:    Data-driven оптимизация качества ответов                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  14. ДАШБОРД РАСХОДОВ И МЕТРИК                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Нет понимания сколько тратим на AI и какова эффективность.      │
│                                                                             │
│  Решение:   Логировать и отображать:                                        │
│             • Стоимость токенов по дням/неделям                             │
│             • Latency генерации                                             │
│             • Hit rate RAG (% запросов с релевантным контекстом)            │
│             • % положительного фидбека по операторам                        │
│                                                                             │
│  Оценка:    6-8 часов                                                       │
│  Эффект:    Контроль расходов, оптимизация по метрикам                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  15. СТАТИСТИКА ОПЕРАТОРА В БОТЕ                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Оператор не видит свою эффективность.                           │
│                                                                             │
│  Решение:   Команда /stats в Telegram боте:                                 │
│             • Сколько подсказок получил                                     │
│             • % использованных                                              │
│             • Среднее время ответа                                          │
│             • Сравнение с командой                                          │
│                                                                             │
│  Оценка:    3-4 часа                                                        │
│  Эффект:    Геймификация, мотивация операторов                              │
└─────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
                    АРХИТЕКТУРНЫЕ УЛУЧШЕНИЯ (Приоритет 5)
════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│  16. МОДУЛЬНАЯ АРХИТЕКТУРА EDGE FUNCTION                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Вся логика в одном файле на 300+ строк — сложно поддерживать.   │
│                                                                             │
│  Решение:   Разбить на модули:                                              │
│             • qc.ts — QC анализ                                             │
│             • rag.ts — RAG поиск                                            │
│             • generation.ts — генерация ответа                              │
│             • notification.ts — отправка в Telegram                         │
│                                                                             │
│  Оценка:    4-6 часов рефакторинга                                          │
│  Эффект:    Читаемость, тестируемость, переиспользование                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  17. ОЧЕРЕДЬ СООБЩЕНИЙ                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Если Edge Function упала — сообщение потеряно.                  │
│                                                                             │
│  Решение:   Использовать очередь (Supabase Queue или pg_notify):            │
│             • Сообщения сначала в очередь                                   │
│             • Обработка с подтверждением                                    │
│             • Retry для failed                                              │
│                                                                             │
│  Оценка:    8-10 часов                                                      │
│  Эффект:    Гарантия обработки 100% сообщений                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  18. ТЕСТОВЫЙ РЕЖИМ                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  Проблема:  Нельзя тестировать изменения без влияния на продакшен.          │
│                                                                             │
│  Решение:   Флаг is_test в конфиге:                                         │
│             • Подсказки отправляются в тестовый Telegram чат                │
│             • Логи в отдельную таблицу                                      │
│             • Возможность сравнить с продакшен версией                      │
│                                                                             │
│  Оценка:    3-4 часа                                                        │
│  Эффект:    Безопасное тестирование изменений                               │
└─────────────────────────────────────────────────────────────────────────────┘

════════════════════════════════════════════════════════════════════════════════
                         ДОРОЖНАЯ КАРТА
════════════════════════════════════════════════════════════════════════════════

ЭТАП 1 — Стабилизация (1-2 недели)
─────────────────────────────────
  □ SQL injection fix
  □ Fallback при ошибках API  
  □ Rate limiting / debounce
  □ Ссылка на сделку в подсказке
  □ Таймер ожидания клиента

ЭТАП 2 — UX улучшения (2-3 недели)
──────────────────────────────────
  □ Кнопка "Отправить клиенту"
  □ Кнопка "Перегенерировать"
  □ Умное управление контекстом
  □ Команда /stats в боте

ЭТАП 3 — Умные фичи (3-4 недели)
────────────────────────────────
  □ Интент-детекция
  □ Интеграция с данными CRM
  □ Sentiment tracking
  □ Ранжирование few-shot примеров

ЭТАП 4 — Аналитика (2-3 недели)
──────────────────────────────
  □ Дашборд расходов и метрик
  □ A/B тестирование промптов
  □ Автоматический learning loop

════════════════════════════════════════════════════════════════════════════════
                         ОЦЕНКА ЭФФЕКТА
════════════════════════════════════════════════════════════════════════════════

После реализации всех этапов ожидается:

  ✓ Снижение расходов на API:           до 40%
  ✓ Ускорение работы операторов:        30-50%
  ✓ Повышение % полезных подсказок:     с ~60% до ~85%
  ✓ Автоматизация рутины:               до 70% типовых ответов
  ✓ Надёжность системы:                 99%+
  ✓ Раннее обнаружение проблем:         -50% эскалаций

════════════════════════════════════════════════════════════════════════════════

