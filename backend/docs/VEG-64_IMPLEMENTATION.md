# VEG-64: –°–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ VEG-64 –ø–æ —É–ª—É—á—à–µ–Ω–∏—é —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ CRM.

## 1. –§–æ—Ä–º–∞—Ç —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

### –î–æ–±–∞–≤–ª–µ–Ω timestamp —Å —Å–µ–∫—É–Ω–¥–∞–º–∏

–í—Å–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—é—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `DD.MM.YY HH:MM:SS`:

**–ü—Ä–∏–º–µ—Ä—ã:**
- `üîÑ –ê–Ω–Ω–∞ —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞: –ü–µ—Ä–µ–¥–∞–Ω–æ –ù–∏–∫–∏—Ç–µ (–±—ã–ª–æ: –ü—Ä–∏–Ω—è—Ç–æ –ê–Ω–Ω–∞) 06.02.26 21:45:31`
- `üè∑Ô∏è –ò–≤–∞–Ω –¥–æ–±–∞–≤–∏–ª —Ç–µ–≥ "–í–∞–∂–Ω—ã–π –∫–ª–∏–µ–Ω—Ç" 06.02.26 21:45:31`
- `üè∑Ô∏è –ú–∞—Ä–∏—è —É–¥–∞–ª–∏–ª —Ç–µ–≥ "–¢–µ—Å—Ç" 06.02.26 21:45:31`
- `üìù –ó–∞–º–µ—Ç–∫–∞: –ö–ª–∏–µ–Ω—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å –∑–∞–≤—Ç—Ä–∞ 06.02.26 21:45:31`

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `backend/routes/orders.js` - —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞ (–æ–±—ã—á–Ω–∞—è –∏ –º–∞—Å—Å–æ–≤–∞—è)
- `backend/routes/tags.js` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤
- `backend/routes/bubble.js` - –Ω–æ–≤—ã–µ webhook endpoints

## 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

### 2.1 –°–º–µ–Ω–∞ —ç—Ç–∞–ø–∞
**–ì–¥–µ:** `backend/routes/orders.js`

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ `internal_messages`:
- –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É `order_id` (–ù–ï –∫ `main_id`)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Socket.IO —Å–æ–±—ã—Ç–∏–µ `new_internal_message` —Ç–æ–ª—å–∫–æ –≤ –∫–æ–º–Ω–∞—Ç—É —ç—Ç–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
- –§–æ—Ä–º–∞—Ç: `üîÑ {manager_name} —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞: {new_status} (–±—ã–ª–æ: {old_status}) {timestamp}`

### 2.2 –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
**–ì–¥–µ:** `backend/routes/tags.js` - `POST /api/tags/order/:orderId/assign`

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–≥–∞ –∫ –∑–∞–∫–∞–∑—É:
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–≥–µ
- –§–æ—Ä–º–∞—Ç: `üè∑Ô∏è {manager_name} –¥–æ–±–∞–≤–∏–ª —Ç–µ–≥ "{tag_name}" {timestamp}`

### 2.3 –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
**–ì–¥–µ:** `backend/routes/tags.js` - `DELETE /api/tags/order/:orderId/remove/:tagId`

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ–≥–∞ –∏–∑ –∑–∞–∫–∞–∑–∞:
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –§–æ—Ä–º–∞—Ç: `üè∑Ô∏è {manager_name} —É–¥–∞–ª–∏–ª —Ç–µ–≥ "{tag_name}" {timestamp}`

## 3. –ù–æ–≤—ã–µ Webhook Endpoints

### 3.1 POST /api/webhook/bubble/note_to_user

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–µ—Ç –∑–∞–º–µ—Ç–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–æ –≤—Å–µ –µ–≥–æ –æ—Ä–¥–µ—Ä–∞ + –≤ —Ä–∞–∑–¥–µ–ª "–ó–∞–º–µ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞")

**Payload:**
```json
{
  "user": "<user_id>",  // Telegram ID –∏–ª–∏ Bubble User ID
  "note": "<note_text>"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ `user` (–ø—Ä–æ–±—É–µ—Ç Telegram ID, –∑–∞—Ç–µ–º Bubble User ID —á–µ—Ä–µ–∑ API)
2. –ü–æ–ª—É—á–∞–µ—Ç –í–°–ï –æ—Ä–¥–µ—Ä–∞ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
3. –°–æ–∑–¥–∞–µ—Ç —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ `internal_messages` –¥–ª—è –ö–ê–ñ–î–û–ì–û –æ—Ä–¥–µ—Ä–∞
4. –°–æ–∑–¥–∞–µ—Ç –∑–∞–º–µ—Ç–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ `notes` —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ `contact_id`
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Socket.IO —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ä–¥–µ—Ä–∞

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
üìù –ó–∞–º–µ—Ç–∫–∞: {note_text} {timestamp}
```

**Response:**
```json
{
  "success": true,
  "contact_id": 123,
  "messages_created": 5,
  "note_created": true
}
```

**–û—à–∏–±–∫–∏:**
- `400` - Missing required fields
- `404` - Contact not found
- `500` - Server error

### 3.2 POST /api/webhook/bubble/note_to_order

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–µ—Ç –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ—Ç –æ—Ä–¥–µ—Ä, –Ω–µ –≤ —Å–∫–≤–æ–∑–Ω–æ–π –∫–æ–ª–æ–¥–µ—Ü)

**Payload:**
```json
{
  "main_id": "<main_id>",  // Main ID –æ—Ä–¥–µ—Ä–∞
  "note": "<note_text>"
}
```

**–õ–æ–≥–∏–∫–∞:**
1. –ù–∞—Ö–æ–¥–∏—Ç –æ—Ä–¥–µ—Ä –ø–æ `main_id`
2. –°–æ–∑–¥–∞–µ—Ç —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Socket.IO —Å–æ–±—ã—Ç–∏–µ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–º–Ω–∞—Ç—É —ç—Ç–æ–≥–æ –æ—Ä–¥–µ—Ä–∞

**–§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:**
```
üìù –ó–∞–º–µ—Ç–∫–∞: {note_text} {timestamp}
```

**Response:**
```json
{
  "success": true,
  "order_id": 456,
  "message_id": 789
}
```

**–û—à–∏–±–∫–∏:**
- `400` - Missing required fields
- `404` - Order not found
- `500` - Server error

## 4. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–í—Å–µ –Ω–æ–≤—ã–µ webhook endpoints —Ç—Ä–µ–±—É—é—Ç —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ:
```
X-Webhook-Token: <BUBBLE_WEBHOOK_SECRET>
```
–∏–ª–∏
```
Authorization: Bearer <BUBBLE_WEBHOOK_SECRET>
```

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**Backend URL:** `https://crmvega-g766.onrender.com`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö endpoints:
```bash
curl https://crmvega-g766.onrender.com/api/webhook/bubble
```

### –¢–µ—Å—Ç note_to_user:
```bash
curl -X POST https://crmvega-g766.onrender.com/api/webhook/bubble/note_to_user \
  -H "X-Webhook-Token: your_secret" \
  -H "Content-Type: application/json" \
  -d '{
    "user": "123456789",
    "note": "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö –æ—Ä–¥–µ—Ä–æ–≤"
  }'
```

### –¢–µ—Å—Ç note_to_order:
```bash
curl -X POST https://crmvega-g766.onrender.com/api/webhook/bubble/note_to_order \
  -H "X-Webhook-Token: your_secret" \
  -H "Content-Type: application/json" \
  -d '{
    "main_id": "1769873416276",
    "note": "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ä–¥–µ—Ä–∞"
  }'
```

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
–ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –±—ç–∫–µ–Ω–¥ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
# –ó–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ http://localhost:5001
curl http://localhost:5001/api/webhook/bubble
```

## 6. Socket.IO Events

### new_internal_message
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–º–Ω–∞—Ç—É `order_{order_id}` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

**Payload:**
```javascript
{
  id: 123,
  order_id: 456,
  sender_id: 789, // –∏–ª–∏ null –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  content: "üîÑ –ê–Ω–Ω–∞ —Å–º–µ–Ω–∞ —ç—Ç–∞–ø–∞: ...",
  is_read: false,
  attachment_type: "system",
  created_at: "2026-02-06T18:45:31.000Z"
}
```

## 7. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ internal_messages
–°–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å:
- `order_id` - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ID –æ—Ä–¥–µ—Ä–∞ (–ù–ï main_id!)
- `sender_id` - ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–ª–∏ `null` –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö
- `content` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å timestamp
- `attachment_type: 'system'` - –º–∞—Ä–∫–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `is_read: false` - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–æ

### –¢–∞–±–ª–∏—Ü–∞ notes
–ó–∞–º–µ—Ç–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (—Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `note_to_user`):
- `contact_id` - ID –∫–æ–Ω—Ç–∞–∫—Ç–∞
- `content` - —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ (–±–µ–∑ timestamp)
- `priority: 'info'`
- `manager_id: null` - –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫

## 8. –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –°–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ–π –æ—Ä–¥–µ—Ä
–í—Å–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É `order_id`, –∞ –Ω–µ –∫ `main_id`. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–∑–Ω—ã—Ö –æ—Ä–¥–µ—Ä–∞—Ö –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### ‚úÖ Timestamp –≤–µ–∑–¥–µ
–í—Å–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

### ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –°–º–µ–Ω–∞ —ç—Ç–∞–ø–∞ (–æ–±—ã—á–Ω–∞—è –∏ –º–∞—Å—Å–æ–≤–∞—è)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
- –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞
- –ó–∞–º–µ—Ç–∫–∏ –æ—Ç Bubble (—á–µ—Ä–µ–∑ webhooks)

### ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
–ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Å–Ω–æ–≤–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (—Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞) –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. –û—à–∏–±–∫–∞ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å.

## 9. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º:
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –æ—Ä–¥–µ—Ä–∞ (—Å—É–º–º–∞, –≤–∞–ª—é—Ç–∞ –∏ —Ç.–¥.)
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ UI
- –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–∫—Ä—ã–≤–∞—Ç—å/–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
