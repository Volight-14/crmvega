# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: Bubble Webhook –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏ —á–µ—Ä–µ–∑:
- –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫—É (drag & drop)
- API –∑–∞–ø—Ä–æ—Å `PATCH /api/orders/:id`
- –õ—é–±–æ–µ –¥—Ä—É–≥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–µ–±—Ö—É–∫ –Ω–∞ Bubble —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
```bash
cd backend
node test-bubble-webhook.js
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ API
```bash
# –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ ID –∑–∞—è–≤–∫–∏
curl -X PATCH http://localhost:3001/api/orders/YOUR_ORDER_ID \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"status": "survey"}'
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
1. –û—Ç–∫—Ä–æ–π—Ç–µ CRM –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–µ –≤ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—É—Å
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend - –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   [Bubble Webhook] Sending status change: { ... }
   [Bubble Webhook] ‚úÖ Success (attempt 1/3): { ... }
   ```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–í—Å–µ –≤–µ–±—Ö—É–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å backend —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[Bubble Webhook]`:

- **–û—Ç–ø—Ä–∞–≤–∫–∞**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç main_id, —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
- **–£—Å–ø–µ—Ö**: ‚úÖ —Å –∫–æ–¥–æ–º –æ—Ç–≤–µ—Ç–∞ –∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç Bubble
- **–û—à–∏–±–∫–∞**: ‚ùå —Å –¥–µ—Ç–∞–ª—è–º–∏ –æ—à–∏–±–∫–∏ –∏ –Ω–æ–º–µ—Ä–æ–º –ø–æ–ø—ã—Ç–∫–∏
- **–ü–æ–≤—Ç–æ—Ä**: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–µ—Ä–∂–∫–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `/backend/utils/bubbleWebhook.js`:

- `webhookUrl` - URL –≤–µ–±—Ö—É–∫–∞ Bubble (—Å—Ç—Ä–æ–∫–∞ 30)
- `retries` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
- `timeout` - —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10 —Å–µ–∫—É–Ω–¥)
- `STATUS_TO_BUBBLE_ID` - –º–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 4-21)

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `/backend/utils/bubbleWebhook.js`
2. –î–æ–±–∞–≤—å—Ç–µ –º–∞–ø–ø–∏–Ω–≥ –≤ –æ–±—ä–µ–∫—Ç `STATUS_TO_BUBBLE_ID`:
   ```javascript
   'your_internal_status': 'BUBBLE_STATUS_ID',
   ```
3. –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç–µ `/backend/utils/statusMapping.js` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞

## üêõ –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ –≤–µ–±—Ö—É–∫ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ main_id**: –ó–∞—è–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –ø–æ–ª–µ `main_id`
   ```
   [Bubble Webhook] Skipping: main_id is missing for order XXX
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –µ—Å—Ç—å –≤ –º–∞–ø–ø–∏–Ω–≥–µ
   ```
   [Bubble Webhook] Unknown status mapping for: your_status
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç—å**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ Bubble
   ```
   [Bubble Webhook] ‚ùå Error: Network Error
   ```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–°–º. –ø–æ–ª–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ `/BUBBLE_WEBHOOK.md`
